---
title: "PyTest: 테스트를 위한 라이브러리 - 모킹, Fixture"
excerpt: "현재 진행하는 프로젝트에 PyTest를 사용할 지 생각하며 아래 내용을 정리했다."

categories:
  - TIL
tags:
  - [TIL, PyTest, Unittest, 모킹, Fixture]

toc: true

last_modified_at: 2025-09-12
# thumbnail: ../images/TIL.png
---

현재 진행하는 프로젝트에 PyTest를 사용할 지 생각하며 아래 내용을 정리했다.

# PyTest
PyTest: 파이썬에서 웹 프로젝트의 테스트 코드 작성을 위한 라이브러리

# **테스트 코드**
    - 어떤 API를 변경하거나 ORM과 같은 새로운 기술을 적용할 때마다 기존의 API가 정상적으로 동작하는지 확인하기 위해서 직접 API를 호출해봐야 한다면 생각보다 많은 시간과 노력이 소모된다.
    - ⇒ 이런 경우, 테스트 코드를 이용하면 반복적으로 이루어져야 하는 과정을 대신할 수 있다!
    - 개발자가 일일이 API 호출해보지 않고도 테스트 코드에 의해 API를 대신 동작시키고 과정과 결과를 검증
    - 안정적인 프로젝트 운영을 위해 반드시 필요한 기술

# Unittest(파이썬 표준 테스트 프레임워크)와 다른 PyTest의 차별점
- 간결한 문법: 하나의 assert문으로 모든 것 표현 가능, 함수 단위 테스트 지원
- fixture 지원: 테스트 데이터 관리

# PyTest 사용 방법

1) 라이브러리 설치      
```
pip install pytest
pip install httpx 
```

2) 파이썬 패키지 설정       
tests/ 폴더 생성 후 빈 **`__init__.py`** 생성 (파이썬 패키지로 인식되기 위함)

3) 테스트 코드 파일 생성        
`test_main.py`와 같이 **`test_무엇무엇` 형식에 맞춰** 파일 생성 (PyTest에게 테스트로 인식되기 위함)

4) 테스트 코드 작성     
`test_`로 시작하는 함수 작성        
```py
from fastapi.testclient import TestClient
from main import app

client = TestClient(app=app)

def test_health_check():
    response = client.get("/")
    assert response.status_code == 200
    assert response.json() == {"ping": "pong"} # 응답의 JSON 데이터 정상 리턴 확인
```

5) pytest 실행
터미널에 `pytest` 명령 -> 테스트 코드가 실행됨

# +a. `.pytest_cache`
한번 테스트 코드를 돌리고 나면 `.pytest_cache`라는 디렉토리가 자동으로 생성된다. 이 디렉토리는 PyTest가 테스트 코드들을 탐색하고, 테스트를 돌리는 등의 과정에서 경로 혹은 결과값에 대한 정보를 별도로 관리해준다. 만약 PyTest가 경로를 잘 못 찾을 경우 이 캐시를 한번씩 지워주면 도움이 될 수 있다.

# 모킹(Mocking)
POST API, PATCH/PUT API 등의 방식은 DB 속 데이터를 변경할 수 있다. 그런데 단순 테스트가 목적인 상황에서 실제 데이터에 영향을 주면 안 될 것이다. 
따라서 테스트를 할 때에는, 실제 데이터베이스에 요청을 하지 않지만 마치 데이터베이스에 요청을 한 것처럼 흉내내는 기술인 '모킹'이 시용된다.

## 모킹의 사용 예시
- 시간이 오래 걸리는 동작이 있을 때  
    - 외부 API 이용, 데이터베이스 요청 등

## 설치 방법
```
pip install pytest-mock
```

# PyTest의 Fixture
Fixture는 테스트 코드 안에서 반복적으로 사용하는 데이터나 객체를 쉽게 재사용할 수 있도록 도와주는 PyTest의 기능이다.

## Fixture의 사용 예시
위에서 PyTest 테스트 코드 작성 시 아래와 같은 코드를 작성했었다.

```python
from fastapi.testclient import TestClient
from main import app

client = TestClient(app=app)
```

그런데 이런 식으로 파일마다 객체를 생성할 필요 없이 미리 'fixture'로 등록해두게 되면 어디서든 재사용이 가능하다.

## 사용 방법
`@pytest.fixture`라는 데코레이터 추가 -> PyTest가 해당 함수를 fixture로 인식

```py
import pytest

from fastapi.testclient import TestClient
from main import app

@pytest.fixture
def client():
    return TestClient(app=app)
```

이렇게 fixture로 client를 등록해주면, 아래와 같이 다른 파일에서도 함수의 인자로 client를 사용할 수 있게 된다.

```py
def test_health_check(client):
    ...
```

참고: [인프런 - FastAPI 입문 강의](https://www.inflearn.com/course/%EC%8B%A4%EC%A0%84-fastapi-%EC%9E%85%EB%AC%B8)
