---
title:  ì´ë©”ì¼ ë°œì†¡ API ìŠ¤í‚¤ë§ˆ ì´ˆì•ˆ ì‘ì„±
excerpt: "ì´ë©”ì¼ ë°œì†¡ API ìŠ¤í‚¤ë§ˆ ì´ˆì•ˆ ì‘ì„±"

categories:
  - TIL
tags:
  - [TIL, FastAPI, Todo, API ìŠ¤í‚¤ë§ˆ]

toc: true

last_modified_at: 2025-06-11
# thumbnail: ../images/TIL.png
---

# ğŸ“¨ ì´ë©”ì¼ ë°œì†¡ API ìŠ¤í‚¤ë§ˆ ì˜ˆì‹œ
## ğŸ” ì¸ì¦ í—¤ë”
```text
Authorization: Bearer a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
```

## ğŸ“¤ 1. ì´ë©”ì¼ ë°œì†¡ ìš”ì²­ ìŠ¤í‚¤ë§ˆ
### ê¸°ë³¸ ìš”ì²­ (POST /api/v1/email/send)
```json
{
  "template_type": 1,                    // 1: íšŒì›ê°€ì…, 2: ë¹„ë²ˆì¬ì„¤ì •, 3: ê³µì§€ì‚¬í•­
  "to_email": "user@example.com",
  "to_name": "í™ê¸¸ë™",
  "template_variables": {                // í…œí”Œë¦¿ì— ë“¤ì–´ê°ˆ ë™ì  ë³€ìˆ˜
    "user_name": "í™ê¸¸ë™",
    "verification_code": "123456"
  }
}
```

### ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ìš”ì²­ ì˜ˆì‹œ
```json
{
  "template_type": 2,
  "to_email": "user@example.com", 
  "to_name": "ê¹€ì² ìˆ˜",
  "template_variables": {
    "user_name": "ê¹€ì² ìˆ˜",
    "reset_link": "https://example.com/reset?token=abc123"
  }
}
```

## âœ… 2. ì„±ê³µ ì‘ë‹µ ìŠ¤í‚¤ë§ˆ
### HTTP 200 - ë°œì†¡ ì„±ê³µ
```json
{
  "code": 200,
  "message": "ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.",
  "data": {
    "request_id": "req_a1b2c3d4e5",       // ìš°ë¦¬ ì‹œìŠ¤í…œ ì¶”ì  ID
    "ncloud_id": "ncloud_20240607_xyz789", // NCloud ìš”ì²­ ID
    "status": "sent",                      // ë°œì†¡ ìƒíƒœ
    "sent_at": "2024-06-07T10:30:00Z",     // ë°œì†¡ ì‹œê°„
    "to_email": "user@example.com",        // ìˆ˜ì‹ ì ì´ë©”ì¼
    "template_type": 1                     // ì‚¬ìš©ëœ í…œí”Œë¦¿ íƒ€ì…
  }
}
```

## âŒ 3. ì‹¤íŒ¨ ì‘ë‹µ ìŠ¤í‚¤ë§ˆ
### HTTP 400 - ì˜ëª»ëœ ìš”ì²­
```json
{
  "code": 40001,
  "message": "ì˜ëª»ëœ í…œí”Œë¦¿ íƒ€ì…ì…ë‹ˆë‹¤.",
  "error": "template_type '99' does not exist in templates table",
  "data": {
    "request_id": "req_b2c3d4e5f6",
    "template_type": 99,
    "available_templates": [1, 2, 3]
  }
}
```

### HTTP 400 - í•„ìˆ˜ ë³€ìˆ˜ ëˆ„ë½
```json
{
  "code": 40002,
  "message": "í•„ìˆ˜ í…œí”Œë¦¿ ë³€ìˆ˜ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.",
  "error": "Missing required template variables: ['user_name', 'verification_code']",
  "data": {
    "request_id": "req_c3d4e5f6g7",
    "template_type": 1,
    "missing_variables": ["user_name", "verification_code"],
    "provided_variables": ["email"]
  }
}
```

### HTTP 403 - ê¶Œí•œ ì—†ìŒ
```json
{
  "code": 40301,
  "message": "í—ˆìš©ë˜ì§€ ì•Šì€ IPì—ì„œì˜ ìš”ì²­ì…ë‹ˆë‹¤.",
  "error": "IP address '192.168.1.999' is not in allowed list",
  "data": {
    "client_ip": "192.168.1.999",
    "allowed_ips": ["192.168.1.1", "127.0.0.1"]
  }
}
```

### HTTP 500 - NCloud API ì˜¤ë¥˜
```json
{
  "code": 50001,
  "message": "ì™¸ë¶€ ì„œë¹„ìŠ¤ ì˜¤ë¥˜ë¡œ ì¸í•´ ì´ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.",
  "error": "NCloud API Error: Authentication failed",
  "data": {
    "request_id": "req_e5f6g7h8i9",
    "ncloud_error": "Invalid signature",
    "retry_available": true
  }
}
```

## ğŸ” 4. í…œí”Œë¦¿ ë³€ìˆ˜ ë§¤í•‘ ì˜ˆì‹œ
### í…œí”Œë¦¿ íƒ€ì…ë³„ í•„ìˆ˜ ë³€ìˆ˜:
```json
TEMPLATE_VARIABLES = {
    1: {  # íšŒì›ê°€ì…
        "required": ["user_name", "verification_code"],
        "optional": ["company_name", "welcome_message"]
    },
    2: {  # ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
        "required": ["user_name", "reset_link"],
        "optional": ["expire_time"]
    },
    3: {  # ê³µì§€ì‚¬í•­
        "required": ["title", "content"],
        "optional": ["send_date", "contact_info"]
    }
}
```

### í…œí”Œë¦¿ ë Œë”ë§ ì˜ˆì‹œ:
```html
<!-- templates.html_content (template_type = 1) -->
<h1>{{user_name}}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</h1>
<p>ì¸ì¦ì½”ë“œ: {{verification_code}}</p>

<!-- ë Œë”ë§ í›„ email_logs.final_html_content -->
<h1>í™ê¸¸ë™ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</h1>
<p>ì¸ì¦ì½”ë“œ: 123456</p>
```

# ğŸ”§ ìŠ¤í‚¤ë§ˆ ë³€í™˜ ë¡œì§
## FastAPI ì„œë²„ ë‚´ë¶€ ë³€í™˜ ê³¼ì •

```json
# 1. í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ (ìš°ë¦¬ ìŠ¤í‚¤ë§ˆ)
client_request = {
    "template_type": 1,
    "to_email": "user@example.com",
    "to_name": "í™ê¸¸ë™",
    "template_variables": {"user_name": "í™ê¸¸ë™", "verification_code": "123456"}
}

# 2. í…œí”Œë¦¿ ì¡°íšŒ & ë Œë”ë§
template = get_template_from_db(template_type=1)
# template.subject_template = "{{user_name}}ë‹˜ ê°€ì…ì„ ì¶•í•˜í•©ë‹ˆë‹¤!"
# template.html_content = "<h1>{{user_name}}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</h1><p>ì¸ì¦ì½”ë“œ: {{verification_code}}</p>"

rendered_subject = render_template(template.subject_template, client_request["template_variables"])
rendered_body = render_template(template.html_content, client_request["template_variables"])

# 3. NCloud API í˜•ì‹ìœ¼ë¡œ ë³€í™˜
ncloud_request = {
    "senderAddress": "noreply@ourservice.com",  # í™˜ê²½ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´
    "title": rendered_subject,  # "í™ê¸¸ë™ë‹˜ ê°€ì…ì„ ì¶•í•˜í•©ë‹ˆë‹¤!"
    "body": rendered_body,      # "<h1>í™ê¸¸ë™ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!</h1><p>ì¸ì¦ì½”ë“œ: 123456</p>"
    "recipients": [
        {
            "address": client_request["to_email"],
            "name": client_request["to_name"],
            "type": "R",
            "parameters": {}  # NCloud í…œí”Œë¦¿ ë³€ìˆ˜ (ìš°ë¦¬ëŠ” ë¯¸ë¦¬ ë Œë”ë§í–ˆìœ¼ë¯€ë¡œ ë¹„ì–´ìˆìŒ)
        }
    ],
    "individual": True,
    "advertising": False
}

# 4. NCloud API í˜¸ì¶œ
ncloud_response = call_ncloud_api(ncloud_request)

# 5. ìš°ë¦¬ ì‘ë‹µ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
our_response = {
    "code": 200,
    "message": "ì´ë©”ì¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.",
    "data": {
        "request_id": "req_abc123",
        "ncloud_id": ncloud_response["requestId"],
        "status": "sent"
    }
}
```